<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="metrix-output">
		<ee:transform doc:name="Set Result, Environments For Analysis, Applications For Analysis">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="period"><![CDATA[%dw 2.0
output application/json
var types = payload.timeType
---
payload.period ++ types]]></ee:set-variable>
				<ee:set-variable variableName="environmentsForAnalysis"><![CDATA[payload.environments default ${environments}]]></ee:set-variable>
				<ee:set-variable variableName="applicationsForAnalysis"><![CDATA[(payload.applications splitBy  ",") default ${applications}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="retrieveToken" name="retrieveToken" />
		<flow-ref doc:name="retrieveOrganizationId" name="retrieveOrganizationId" />
		<flow-ref doc:name="retrieveProxyAndDB" name="retrieveProxyAndDB" />
		<flow-ref doc:name="retrieveEnvironments" doc:id="0fc0b4c8-f562-471a-b840-0993c17fcf39" name="retrieveEnvironments"/>
		<set-variable value="#[[]]" doc:name="Set Result" variableName="result" />
		<flow-ref doc:name="handlingApplicationsForMetrix" name="handling-applications-for-metrix" />
		<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;vars.result + vars.environmentApplication]" doc:name="Set Result" variableName="result" />
		<parse-template doc:name="Parse Template" location="webapp\metrics.html" />
	</sub-flow>
	<sub-flow name="handling-applications-for-metrix" >
		<set-variable value="#[vars.environmentsForAnalysis]" doc:name="Set CurrentEnv" doc:id="5fae7ee4-eef9-49d0-9559-c94fe66a4cac" variableName="currentEnv"/>
		<flow-ref doc:name="retrieveApplications" doc:id="4818d393-ec55-4479-9dcb-33cf6cf87836" name="retrieveApplications" />
		<set-variable value="#[[]]" doc:name="Set ApplicationsForOutput" doc:id="194716c7-36c2-4123-ae50-2eb32058a684" variableName="applicationsForOutput" />
		<foreach doc:name="For Each by applications" collection="#[vars.applications filter (vars.applicationsForAnalysis contains $.domain)]" >
			<flow-ref doc:name="handlingIOBoundRequests" name="handling-iobound-requests" />
			<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;vars.applicationsForOutput + vars.IOBoundRequests]" doc:name="Set ApplicationsForOutput" variableName="applicationsForOutput" />
		</foreach>
		<set-variable value='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10; "environment": vars.currentEnv,&#10; "applications": vars.applicationsForOutput&#10;}]' doc:name="Set EnvironmentApplication" variableName="environmentApplication" />
	</sub-flow>
	<sub-flow name="handling-iobound-requests" >
		<ee:transform doc:name="Set currentApp, currentAppName, inboundRequests">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="currentApp"><![CDATA[payload.fullDomain]]></ee:set-variable>
				<ee:set-variable variableName="inboundRequests" ><![CDATA[[]]]></ee:set-variable>
				<ee:set-variable variableName="currentAppName" ><![CDATA[payload.domain	]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<set-variable value='#[output application/java&#10;---&#10;"curl \"https://anypoint.mulesoft.com/monitoring/api/visualizer/api/datasources/proxy/" ++ vars.proxy as String ++ "/query?db=" ++ vars.DB as String ++ "&amp;q=SELECT%20sum(%22avg_request_count%22)%20FROM%20%22app_inbound_metric%22%20WHERE%20(%22org_id%22%20%3D%20%27" ++ vars.org_id as String ++ "%27%20AND%20%22env_id%22%20%3D%20%27" ++ (vars.environments filter $.name == vars.currentEnv).id[0] as String ++ "%27%20AND%20%22app_id%22%20%3D%20%27" ++ vars.currentApp as String ++ "%27%20AND%20%22endpoint_type%22%20%3D%20%27http%27%20AND%20%22endpoint%22%20!%3D%20%27%27)%20AND%20time%20%3E%3D%20now()%20-%20" ++ vars.period as String ++ "%20GROUP%20BY%20%22endpoint%22%20tz(%27Europe%2FMinsk%27)&amp;epoch=ms\" -H \"Authorization: Bearer " ++ vars.token as String ++ "\" --ssl-no-revoke"]' doc:name="Set Q for inbound requests" variableName="q" />
		<until-successful maxRetries="5" doc:name="Until Successful" millisBetweenRetries="1000">
			<scripting:execute engine="groovy" doc:name="Get inboundRequests">
			<scripting:code><![CDATA[def sout = new StringBuilder(), serr = new StringBuilder()
def curl = vars.q
def proc = curl.execute()

proc.consumeProcessOutput(sout, serr)

proc.waitForOrKill(1000)

def out = sout.toString()

println "$out"

return "$out"]]></scripting:code>
		</scripting:execute>
			<flow-ref doc:name="retryIfEmptyPayload" name="retry-Iif-empty-payload"/>
		</until-successful>
		<ee:transform doc:name="Set inboundRequests" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="inboundRes" ><![CDATA[%dw 2.0
output application/json
var inputArray = read(payload default "","application/json").results.series[0]
---
inputArray map ((item) -> {
    "name" : item.tags.endpoint,
    "count": item.values[0][1]
})]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<set-variable value='#[output application/java&#10;---&#10;"curl \"https://anypoint.mulesoft.com/monitoring/api/visualizer/api/datasources/proxy/" ++ vars.proxy as String ++ "/query?db=" ++ vars.DB as String ++ "&amp;q=SELECT%20sum(%22avg_request_count%22)%20FROM%20%22app_outbound_metric%22%20WHERE%20(%22org_id%22%20%3D%20%27" ++ vars.org_id as String ++ "%27%20AND%20%22env_id%22%20%3D%20%27" ++ (vars.environments filter $.name == vars.currentEnv).id[0] as String ++ "%27%20AND%20%22app_id%22%20%3D%20%27" ++ vars.currentApp as String ++ "%27%20AND%20%22endpoint_type%22%20%3D%20%27http%27%20AND%20%22endpoint%22%20!%3D%20%27%27)%20AND%20time%20%3E%3D%20now()%20-%20" ++ vars.period as String ++ "%20GROUP%20BY%20%22endpoint%22%20tz(%27Europe%2FMinsk%27)&amp;epoch=ms\" -H \"Authorization: Bearer " ++ vars.token as String ++ "\" --ssl-no-revoke"]' doc:name="Set Q for outbound requests" variableName="q" />
		<until-successful maxRetries="5" doc:name="Until Successful1" millisBetweenRetries="1000">
			<scripting:execute engine="groovy" doc:name="Get outboundRequests">
				<scripting:code><![CDATA[def sout = new StringBuilder(), serr = new StringBuilder()
def curl = vars.q
def proc = curl.execute()

proc.consumeProcessOutput(sout, serr)

proc.waitForOrKill(1000)

def out = sout.toString()

println "$out"

return "$out"]]></scripting:code>
			</scripting:execute>
			<flow-ref doc:name="retryIfEmptyPayload" name="retry-Iif-empty-payload" />
		</until-successful>
		<ee:transform doc:name="Set outboundRequests">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="outboundRes" ><![CDATA[%dw 2.0
output application/json
var inputArray = read(payload default "","application/json").results.series[0]
---
inputArray map ((item) -> {
    "name" : item.tags.endpoint,
    "count": item.values[0][1]
})]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<set-variable value='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10; "application name": vars.currentAppName,&#10; "inboundRequests": vars.inboundRes,&#10; "outboundRequests" : vars.outboundRes&#10;}]' doc:name="Set ApplicationInstances" variableName="IOBoundRequests" />
	</sub-flow>
	<sub-flow name="retry-Iif-empty-payload" >
		<choice doc:name="Choice">
				<when expression='#[payload == ""]'>
					<raise-error doc:name="Raise error" type="CUSTOM:PAYLOAD_IS_EMPTY" />
				</when>
			</choice>
	</sub-flow>
</mule>
